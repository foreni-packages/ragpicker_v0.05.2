# Copyright (C) 2013 Ragpicker Developers.
# This file is part of Ragpicker Malware Crawler - http://code.google.com/p/malware-crawler/

import re
import logging
from core.abstracts import Crawler

try:
    from yapsy.IPlugin import IPlugin
except ImportError:
    raise ImportError, 'Yapsy (Yet Another Plugin System) is required to run this program : http://yapsy.sourceforge.net'

log = logging.getLogger("MalwaredlCrawler")

class Malwaredl(IPlugin, Crawler):
         
    def run(self):
        self.mapURL = {}
        mdl=[]
        mdl_sites=[]
        log.info("Fetching from Malware Domain List")
        
        #parser
        soup = self.parse('http://www.malwaredomainlist.com/hostslist/mdl.xml')
        
        for row in soup('description'):
            mdl.append(row)
        del mdl[0]
        
        for row in mdl:
            site = re.sub('&amp;','&',str(row).split()[1]).replace(',','')
            if site == '-':
                mdl_sites.append(re.sub('&amp;','&',str(row).split()[4]).replace(',',''))
            else:
                mdl_sites.append(site)
                
        log.info("Found %s urls" % len(mdl))
        
        for row in mdl_sites:
            self.storeURL(row)    
            
        return self.mapURL